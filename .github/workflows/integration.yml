name: Integration Tests

on:
    push:
        branches: [main, feature/**]
    pull_request:
        branches: [main]

jobs:
    integration:
        runs-on: ubuntu-latest
        timeout-minutes: 40
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: Start pgvector Postgres via docker compose
              run: |
                  docker compose -f infra/docker-compose.yml up -d db

            - name: Wait for Postgres to be ready
              run: |
                  sudo apt-get update && sudo apt-get install -y postgresql-client
                  for i in {1..60}; do pg_isready -h 127.0.0.1 -p 5433 && break || sleep 1; done

            - name: Install Python deps
              working-directory: apps/api-py
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run Alembic migrations
              working-directory: apps/api-py
              env:
                  DATABASE_URL: postgresql://nargis:nargis@127.0.0.1:5433/nargis
              run: |
                  alembic upgrade head

            - name: Run tests
              working-directory: apps/api-py
              env:
                  DATABASE_URL: postgresql://nargis:nargis@127.0.0.1:5433/nargis
              run: |
                  pytest -q tests

            - name: Tear down postgres
              if: always()
              run: |
                  docker compose -f infra/docker-compose.yml down --volumes
